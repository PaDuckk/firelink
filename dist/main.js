#!/usr/bin/env node
(function () {var l={};Object.defineProperty(l,"__esModule",{value:!0});const n=require("child_process");var h=({command:r,args:e,cwd:s}={command:"npx",args:[]},o=!0)=>new Promise(($,p)=>{const c=n.spawn(r,e,{cwd:s});o&&c.stderr.pipe(process.stderr),o&&c.stdout.pipe(process.stdout),c.on("close",r=>0!==r?p(!!r):$(!!r))});l.Worker=h;var b={};Object.defineProperty(b,"__esModule",{value:!0});var t=e=>process.argv.toString().includes(e);b.includes=t;var q=(e,r=!0,t=e=>e)=>{if(process.argv.toString().includes(e)){const s=process.argv[process.argv.indexOf(e)+1];return s?s.includes("--")?r:t(s):r}return r};b.nextOrDefault=q;var e={},a=e&&e.__awaiter||function(e,i,r,a){return new(r||(r=Promise))(function($,n){function t(e){try{s(a.next(e))}catch(i){n(i)}}function o(e){try{s(a.throw(e))}catch(i){n(i)}}function s(e){var i;e.done?$(e.value):(i=e.value,i instanceof r?i:new r(function(e){e(i)})).then(t,o)}s((a=a.apply(e,i||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const d=require("fs"),g=require("util"),k=require("path"),j=".packages";function m(e){return a(this,void 0,void 0,function*(){return JSON.parse((yield g.promisify(d.readFile)(k.join(process.cwd(),e),{encoding:"utf-8"})))})}function i(e,i){d.writeFileSync(k.join(process.cwd(),e),JSON.stringify(i,null,2),{encoding:"utf-8"})}function o(){return a(this,void 0,void 0,function*(){i("package.json",(yield m("package.temp.json"))),yield g.promisify(d.unlink)("package.temp.json")})}function p(e,i){return a(this,void 0,void 0,function*(){yield Promise.all(i.map(({dep:i})=>a(this,void 0,void 0,function*(){e.dependencies[i]=`file:./${j}/${i.split("/")[1]}`}))),yield g.promisify(d.writeFile)("./package.json",JSON.stringify(e,null,2),{encoding:"utf-8"})})}function c(e){return a(this,void 0,void 0,function*(){b.includes("--leave-changes")?(yield g.promisify(d.exists)("package.temp.json"))||i("package.temp.json",e):i("package.json",e),process.exit()})}function r(){return a(this,void 0,void 0,function*(){const e=yield m("package.json");e.fireConfig=e.fireConfig||{};let i=e.fireConfig.runner||"firebase";const r=JSON.parse(JSON.stringify(e));if(b.includes("--revert-changes"))return yield o();try{if(e&&e.fireDependencies){const i=e.fireDependencies,$=Object.keys(i).map(e=>({dep:e,folder:i[e]}));yield Promise.all($.map(({folder:e})=>a(this,void 0,void 0,function*(){const i=["-r","--exclude","node_modules","--exclude","dist","--exclude",".cache",e,`./${j}`];yield h({command:"rsync",args:i})})));try{b.includes("--buildCommand")&&(yield Promise.all((yield g.promisify(d.readdir)(k.join(process.cwd(),j))).map(e=>a(this,void 0,void 0,function*(){yield h({command:"npx",args:b.nextOrDefault("--buildCommand","tsc").split(" "),cwd:k.join(process.cwd(),j,e)},!1)}))))}catch(a){}process.stdin.resume(),process.on("exit",()=>c(r)),process.on("SIGINT",()=>c(r)),process.on("SIGUSR1",()=>c(r)),process.on("SIGUSR2",()=>c(r)),process.on("uncaughtException",()=>c(r)),yield p(e,$)}yield h({command:"npx",args:[i,...process.argv.slice(2).filter(e=>"--leave-changes"!==e&&"--revert-changes"!==e&&"--buildCommand"!==e)]})}catch(a){console.log(a)}c(r)})}var s=r;e.createFirebasePackageSymlink=s;var f={},u=f&&f.__awaiter||function(e,a,n,r){return new(n||(n=Promise))(function(c,t){function i(e){try{f(r.next(e))}catch(a){t(a)}}function $(e){try{f(r.throw(e))}catch(a){t(a)}}function f(e){var a;e.done?c(e.value):(a=e.value,a instanceof n?a:new n(function(e){e(a)})).then(i,$)}f((r=r.apply(e,a||[])).next())})};Object.defineProperty(f,"__esModule",{value:!0});function v(){return u(this,void 0,void 0,function*(){yield e.createFirebasePackageSymlink()})}v();if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=f}else if(typeof define==="function"&&define.amd){define(function(){return f})}})();